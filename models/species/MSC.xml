<?xml version="1.0" encoding="UTF-8" ?>

<fragment>


	
	<override id="tree" name="stateNode" spec="starbeast3.SpeciesTree">
		<taxonset id="tree.taxonset" spec="TaxonSet" >
			
        </taxonset>
	</override>


	<override id="treeLikelihood.$(partition)" tree="@GeneTree.t:$(partition)" name="distribution" spec="ThreadedTreeLikelihood" data="@alignment.$(partition)" siteModel="@siteModel.s:$(partition)">


		<branchRateModel id="SpeciesTreeRelaxedClock.c:$(partition)" spec="starbeast3.StarBeast3Clock" clock.rate="@clockRate.t:$(partition)" geneTree="@treePrior.t:$(partition)" speciesTreeRates="@branchRatesModel.Species"/>

	</override>
		



	
	<populate id="tree.taxonset" function="@mscTaxonSet" />



	<append id="state">

        <tree id="GeneTree.t:$(partition)" name="stateNode">
            <taxonset spec="TaxonSet" alignment="@alignment.$(partition)" />
        </tree>


        <parameter id="popSize" name="stateNode">1.0</parameter>
        <parameter id="popMean" name="stateNode">1.0</parameter>

	</append>
	


	<append id="mcmc">

	    <init id="SBI" spec="starbeast3.StarBeastStartState" birthRate="@birthRate" estimate="false" method="point-estimate" popMean="@popMean" speciesTree="@tree" >
	        <gene idref="GeneTree.t:$(partition)"/>

	        <speciesTreePrior id="SpeciesTreePopSize.Species" spec="starbeast3.SpeciesTreePrior" bottomPopSize="@popSize" gammaParameter="@popMean" popFunction="constant" taxonset="@tree.taxonset" tree="@tree" >
				 <populationModel id="speciesTreePopulationModel" spec="starbeast3.evolution.speciation.ConstantPopulations" populationSizes="@popSize" speciesTree="@tree" />
			</speciesTreePrior>

			<speciesTreeRates id="branchRatesModel.Species" spec="starbeast3.evolution.branchratemodel.UCRelaxedClockModelSB3" estimateRoot="true" realRates="@rates.clock" tree="@tree" stdev="@ucldStdev.clock" />

	    </init>




        



	    <logger fileName="$(filebase).$(partition).trees" logEvery="10000" mode="tree">
			<log spec="starbeast3.GeneTreeLogger" clockModel="@SpeciesTreeRelaxedClock.c:$(partition)" tree="@GeneTree.t:$(partition)"/>
		</logger>



	</append>




	<append id="prior">


        <distribution id="speciescoalescent" spec="beast.core.util.CompoundDistribution">
            <distribution idref="SpeciesTreePopSize.Species"/>
            <distribution id="treePrior.t:$(partition)" spec="starbeast3.GeneTreeForSpeciesTreeDistribution" populationModel="@speciesTreePopulationModel" speciesTree="@tree" speciesTreePrior="@SpeciesTreePopSize.Species" tree="@GeneTree.t:$(partition)"/>
        </distribution>


        <distribution id="speciesTreePopPrior" spec="beast.core.util.CompoundDistribution">


	        <prior id="popMean.prior" name="distribution" x="@popMean">
	            <LogNormal name="distr">
	                <parameter estimate="false" name="M">-5.0</parameter>
	                <parameter  estimate="false" lower="0.0" name="S" upper="5.0">1.25</parameter>
	            </LogNormal>
	        </prior>

	         <prior id="constPopSizesPrior.Species" name="distribution" x="@popSize">
					<distr id="popPriorDistr" spec="beast.math.distributions.InverseGamma" alpha="2.0" beta="@popMean"/>
	         </prior>

	     </distribution>

	</append>







    <override name="logger" id="treeLogger" fileName="$(filebase).trees" logEvery="10000" mode="tree">
        <log spec="starbeast3.SpeciesTreeLogger" metadata="@rates.clock" popSize="@popSize" speciesTreePrior="@SpeciesTreePopSize.Species" tree="@tree">
            <treetop id="treeTopFinder" spec="beast.evolution.speciation.TreeTopFinder">
                <tree idref="GeneTree.t:$(partition)"/>
            </treetop>
    	</log>
	</override>




	<append id="gene.tree.height.operator">

        <operator id="AdaptableNodeHeightOperator.$(partition)" spec="orc.operators.AdaptableOperatorSampler" tree="@GeneTree.t:$(partition)" weight="1.0">

	  		<operator id="TreeScaler.t:$(partition)" spec="ScaleOperator" scaleFactor="0.95" tree="@GeneTree.t:$(partition)" weight="1.0"/>
	        <operator id="TreeRootScaler.t:$(partition)" spec="ScaleOperator" rootOnly="true" scaleFactor="0.7" tree="@GeneTree.t:$(partition)" weight="1.0"/>
	        <operator id="UniformOperator.t:$(partition)" spec="Uniform" tree="@GeneTree.t:$(partition)" weight="1.0"/>
	        <operator idref="SubtreeSlide.t:$(partition)" spec="SubtreeSlide" size="0.002" tree="@GeneTree.t:$(partition)" weight="1.0"/>


	         <operator id="Reheight.t:Species" spec="starbeast3.operators.NodeReheight2" taxonset="@tree.taxonset" tree="@tree" weight="1.0">
				<gene idref="treePrior.t:$(partition)"/>
	        </operator>
	            
	        <operator id="coordinatedUniform.t:Species" spec="starbeast3.operators.CoordinatedUniform" speciesTree="@tree" weight="1.0">
				<gene idref="treePrior.t:$(partition)"/>
	        </operator>
	            
	        <operator id="coordinatedExponential.t:Species" spec="starbeast3.operators.CoordinatedExponential" speciesTree="@tree" weight="1.0">
				<gene idref="treePrior.t:$(partition)"/>
			</operator>

	        
            <operator id="clockUpDownOperator.t:$(partition)" spec="UpDownOperator" scaleFactor="0.95" weight="1.0">
            	<down idref="GeneTree.t:$(partition)"/>
        	</operator>
			

			<operator id="updownAll:Species" spec="UpDownOperator" scaleFactor="0.75" weight="1.0">
	            <up idref="birthRate"/>
	            <down idref="tree"/>
	            <down idref="GeneTree.t:$(partition)"/>
	            <down idref="popSize"/>
	            <down idref="popMean"/>
	        </operator>

        </operator>

	</append>


	<append id="gene.tree.topology.operator">

 		<operator id="AdaptableTopologyOperator.$(partition)" spec="orc.operators.AdaptableOperatorSampler" tree="@GeneTree.t:$(partition)" weight="1.0">
        	<metric spec="beast.evolution.tree.RobinsonsFouldMetric" taxonset="@tree.taxonset"/>

	        <operator id="SubtreeSlide.t:$(partition)" spec="SubtreeSlide" size="0.002" tree="@GeneTree.t:$(partition)" weight="1.0"/>
	        <operator id="Narrow.t:$(partition)" spec="Exchange" tree="@GeneTree.t:$(partition)" weight="1.0"/>
	        <operator id="Wide.t:$(partition)" spec="Exchange" isNarrow="false" tree="@GeneTree.t:$(partition)" weight="1.0"/>
	        <operator id="WilsonBalding.t:$(partition)" spec="WilsonBalding" tree="@GeneTree.t:$(partition)" weight="1.0"/>

        </operator>

	</append>



	<append id="gene.tree.prior.model.operator">


		<operator id="orc.operators.AdaptableOperatorSampler.speciesPop" spec="orc.operators.AdaptableOperatorSampler" weight="1.0">

			<parameter idref="popSize" />
			<operator id="PopSizeGibbsSampler" spec='starbeast3.operators.PopSizeGibbsSampler' weight="1.0" popSizes="@popSize">
				<gammaprior idref="popPriorDistr"/>
				<gene idref="treePrior.t:$(partition)"/>
			</operator>

	        <operator id="constPopSizesSwap.Species" spec="starbeast3.operators.RealCycle" k="2" optimise="false" parameter="@popSize" weight="1.0"/>
	        <operator id="constPopSizesScale.Species" spec="ScaleOperator" parameter="@popSize" scaleFactor="0.5" weight="1.0"/>


	        <operator idref="updownAll:Species" />

		</operator>


        <operator id="constPopMeanScale.Species" spec="ScaleOperator" parameter="@popMean" scaleFactor="0.75" weight="1.0"/>
		
		
	</append>


	<append id="SpeciesTreePriorPOEM">

	</append>



	<append id="GeneTreeTopologyPOEM">
		<log idref="TreeDistanceInit.t:$(partition)" />
		<log idref="TreeDistanceNJ.t:$(partition)" />
		<log idref="TreeDistanceUPGMA.t:$(partition)" />
		<log idref="speciescoalescent" />
	</append>


	<append id="GeneTreeNodeHeightPOEM">

		<log idref="speciescoalescent" />
	</append>



	<append id="GeneTreePriorPOEM">
		<log idref="popMean"/>
		<log idref="popSize"/>
		<log idref="speciescoalescent" />
		<log idref="speciesTreePopPrior" />
		<log idref="SpeciesTreePopSize.Species" />
	</append>



	<append id="TopologyPOEM">
		<log idref="TreeDistanceLogger.species" />
	</append>






	<!--
	<append id="TopologyPOEM.$(partition)">
		<log idref="TreeDistanceInit.t:$(partition)" />
		<log idref="TreeDistanceNJ.t:$(partition)" />
		<log idref="TreeDistanceUPGMA.t:$(partition)" />
		<log idref="speciescoalescent" />
		<operator idref="" />
	</append>
	-->


	<append id="screenlog">
		<log id="d.species" spec="beast.evolution.tree.TreeDistanceLogger" tree="@tree" />
		<log id="d.t:$(partition)" spec="beast.evolution.tree.TreeDistanceLogger" tree="@GeneTree.t:$(partition)" />
	</append>




	<append id="tracelog">
		<log id="TreeStat.t:GeneTree.$(partition)" spec="beast.evolution.tree.TreeStatLogger" tree="@GeneTree.t:$(partition)"/>
		
		<log id="TreeDistanceLogger.species" spec="beast.evolution.tree.TreeDistanceLogger" tree="@tree" />
		<log id="TreeDistanceInit.t:$(partition)" spec="beast.evolution.tree.TreeDistanceLogger" tree="@GeneTree.t:$(partition)" />
		<log id="TreeDistanceNJ.t:$(partition)" spec="beast.evolution.tree.TreeDistanceLogger" tree="@GeneTree.t:$(partition)" >
			<ref spec="beast.util.ClusterTree" clusterType="neighborjoining" taxa="@alignment.$(partition)"/>
		</log>
		<log id="TreeDistanceUPGMA.t:$(partition)" spec="beast.evolution.tree.TreeDistanceLogger" tree="@GeneTree.t:$(partition)" >
			<ref spec="beast.util.ClusterTree" clusterType="upgma" taxa="@alignment.$(partition)"/>
		</log>

		<log idref="popMean"/>
		<log idref="popSize"/>
		

	</append>





</fragment>
	


