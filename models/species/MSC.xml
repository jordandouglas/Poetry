<?xml version="1.0" encoding="UTF-8" ?>

<fragment>


	
	<override id="tree" name="stateNode" spec="starbeast3.SpeciesTree">
		<taxonset id="tree.taxonset" spec="TaxonSet" >
			
        </taxonset>
	</override>


	<override id="treeLikelihood.$(partition)" tree="@GeneTree.t:$(partition)" name="distribution" spec="ThreadedTreeLikelihood" data="@alignment.$(partition)" siteModel="@siteModel.s:$(partition)">


		<branchRateModel id="SpeciesTreeRelaxedClock.c:$(partition)" spec="starbeast3.StarBeast3Clock" clock.rate="@clockRate.c:$(partition)" geneTree="@treePrior.t:$(partition)" speciesTreeRates="@branchRatesModel.Species"/>

	</override>
		



	
	<populate id="tree.taxonset" function="@mscTaxonSet" />


	
	<override id="siteModel.s:$(partition)" name="siteModel" spec="SiteModel" mutationRate="@clockRate.c:$(partition)">

		<parameter id="gammaShape.s:$(partition)" spec="parameter.RealParameter" estimate="false" name="shape">1.0</parameter>
		<substModel spec="HKY" kappa="@kappa.s:$(partition)">
			<frequencies spec="Frequencies" frequencies="@freqParameter.s:$(partition)"/>
		</substModel>

	</override>




	<append id="state">

        <tree id="GeneTree.t:$(partition)" name="stateNode">
            <taxonset spec="TaxonSet" alignment="@alignment.$(partition)" />
        </tree>


        <parameter id="popSize" name="stateNode">1.0</parameter>
        <parameter id="popMean" name="stateNode">1.0</parameter>

	</append>
	


	<append id="mcmc">

	    <init id="SBI" spec="starbeast3.StarBeastStartState" birthRate="@birthRate" estimate="false" method="point-estimate" popMean="@popMean" speciesTree="@tree" >
	        <gene idref="GeneTree.t:$(partition)"/>

	        <speciesTreePrior id="SpeciesTreePopSize.Species" spec="starbeast3.SpeciesTreePrior" bottomPopSize="@popSize" gammaParameter="@popMean" popFunction="constant" taxonset="@tree.taxonset" tree="@tree" >
				 <populationModel id="speciesTreePopulationModel" spec="starbeast3.evolution.speciation.ConstantPopulations" populationSizes="@popSize" speciesTree="@tree" />
			</speciesTreePrior>

			<speciesTreeRates id="branchRatesModel.Species" spec="starbeast3.evolution.branchratemodel.UCRelaxedClockModelSB3" estimateRoot="true" realRates="@rates.clock" tree="@tree" stdev="@ucldStdev.clock" clock.rate="@overallClockRate.c:tree" />

	    </init>




        



	    <logger fileName="$(filebase).$(partition).trees" logEvery="10000" mode="tree">
			<log spec="starbeast3.GeneTreeLogger" clockModel="@SpeciesTreeRelaxedClock.c:$(partition)" tree="@GeneTree.t:$(partition)"/>
		</logger>



	</append>




	<append id="prior">


        <distribution id="speciescoalescent" spec="beast.core.util.CompoundDistribution">
            <distribution idref="SpeciesTreePopSize.Species"/>
            <distribution id="treePrior.t:$(partition)" spec="starbeast3.GeneTreeForSpeciesTreeDistribution" populationModel="@speciesTreePopulationModel" speciesTree="@tree" speciesTreePrior="@SpeciesTreePopSize.Species" tree="@GeneTree.t:$(partition)"/>
        </distribution>


        <distribution id="speciesTreePopPrior" spec="beast.core.util.CompoundDistribution">


	        <prior id="popMean.prior" name="distribution" x="@popMean">
	            <LogNormal id="popMeanLogNormal" name="distr">
	                <parameter estimate="false" name="M">-5.0</parameter>
	                <parameter  estimate="false" lower="0.0" name="S" upper="5.0">1.25</parameter>
	            </LogNormal>
	        </prior>

	         <prior id="constPopSizesPrior.Species" name="distribution" x="@popSize">
					<distr id="popPriorDistr" spec="beast.math.distributions.InverseGamma" alpha="2.0" beta="@popMean"/>
	         </prior>

	     </distribution>

	</append>







    <override name="logger" id="treeLogger" fileName="$(filebase).trees" logEvery="10000" mode="tree">
        <log spec="starbeast3.SpeciesTreeLogger" metadata="@rates.clock" popSize="@popSize" speciesTreePrior="@SpeciesTreePopSize.Species" tree="@tree">
            <treetop id="treeTopFinder" spec="beast.evolution.speciation.TreeTopFinder">
                <tree idref="GeneTree.t:$(partition)"/>
            </treetop>
    	</log>
	</override>





	<!-- Species tree topology -->
	<append id="AdaptableTopologyOperator.tree">


		 <!-- Node reheight -->
        <operator idref="Reheight.t:Species" />

    	<!-- NER -->
    	<operator idref="NEROperator_dAE_dBE_dCE" />

    	<!-- Coordinate narrow exchange -->
		<operator idref="CoordinatedExchange" />

    	<!-- Coordinate narrow exchange rates -->
		<operator idref="CoordinatedExchangeRates" />


	</append>


	<!-- Species tree node heights -->
	<append id="AdaptableNodeHeightOperator.tree">


		<!-- Constant distance -->
        <operator idref="ConstantDistanceOperatorSpeciesTree" />

        <!-- Node reheight -->
        <operator idref="Reheight.t:Species" spec="starbeast3.operators.NodeReheight2" taxonset="@taxonsuperset" tree="@Tree.t:Species" weight="1.0" />


        <!-- Coordinated uniform -->
		<operator idref="coordinatedExponential.t:Species" spec="starbeast3.operators.CoordinatedExponential" speciesTree="@Tree.t:Species" weight="1.0" />


         <!-- Coordinated exponential -->
  		<operator idref="coordinatedUniform.t:Species" spec="starbeast3.operators.CoordinatedUniform" speciesTree="@Tree.t:Species" weight="1.0" />


	</append>


	<!-- Gene tree topology -->
	<append id="gene.tree.topology.operator">


		<operator id="gene.tree.topology.adaptable.operator" spec="orc.operators.AdaptableOperatorSampler" weight="1.0" dimensional="true">



			<!-- Metric: gene tree toplogies -->
			<metric spec="beast.evolution.tree.RobinsonsFouldMetric" taxonset="@tree.taxonset" recursive="true"/>
	    	<tree idref="GeneTree.t:$(partition)"/>



		    <!-- Parallel gene tree operator -->	
			<operator idref="ParallelMCMCTreeOperator" />


			<!-- Adaptable -->
	    	<operator id="AdaptableOperatorSampler.geneTopology.inner" spec="orc.operators.AdaptableOperatorSampler" weight="1.0">

	    		<metric spec="beast.evolution.tree.RobinsonsFouldMetric" taxonset="@tree.taxonset" recursive="true"/>
		    	<tree idref="GeneTree.t:$(partition)"/>


	         	<!-- Subtree slide -->
		    	<operator idref="SubtreeSlide.t:geneTrees" />
		    	

	    		<!-- Wilson balding operator -->
				<operator id="WilsonBalding.t:geneTrees" spec="starbeast3.operators.WilsonBalding" weight="1.0">
					<gene idref="treePrior.t:$(partition)"/>   
				</operator>
				
		            
		        <!-- Wide exchange -->
		        <operator id="Wide.t:geneTrees" spec="starbeast3.operators.Exchange" isNarrow="false" weight="1.0">
		        	<gene idref="treePrior.t:$(partition)"/>     
		        </operator>
		            
		        <!-- Narrow exchange -->
		        <operator id="Narrow.t:geneTrees" spec="starbeast3.operators.Exchange" isNarrow="true" weight="1.0">
		        	<gene idref="treePrior.t:$(partition)"/>   
		        </operator>


		        <!-- Node reheight -->
		        <operator idref="Reheight.t:Species" />

		    	<!-- NER -->
		    	<operator id="NEROperator_dAE_dBE_dCE" spec="orc.ner.NEROperator_dAE_dBE_dCE" tree="@tree" rates="@rates.clock" weight="1"/>

		    	<!-- Coordinate narrow exchange -->
				<operator id="CoordinatedExchange" spec="starbeast3.operators.CoordinatedExchangeRates" tree="@tree"  rates="@rates.clock" weight="1">
					<gene idref="treePrior.t:$(partition)"/> 
				</operator>

		    	<!-- Coordinate narrow exchange rates -->
				<operator id="CoordinatedExchangeRates" spec="starbeast3.operators.NEROperator_dAE_dBE_dCE" tree="@tree" rates="@rates.clock" weight="1">
					<gene idref="treePrior.t:$(partition)"/>   
				</operator>


		  	</operator>

	  </operator>

	</append>



	<!-- Gene tree node heights -->
    <append id="gene.tree.height.operator">


    	<operator id="gene.tree.height.adaptable.operator" spec="orc.operators.AdaptableOperatorSampler" weight="1.0" dimensional="true">


	    	<!-- Metric: gene tree node heights -->
	    	<tree idref="GeneTree.t:$(partition)"/>


			<!-- Parallel gene tree operator -->	
			<operator id="ParallelMCMCTreeOperator" includeRealParameters="false" spec="starbeast3.operators.ParallelMCMCTreeOperator" weight="1" otherState="@state" chainLength="250">
		    	<distribution spec="starbeast3.operators.ParallelMCMCTreeOperatorTreeDistribution" tree="@GeneTree.t:$(partition)" geneprior="@treePrior.t:$(partition)" treelikelihood="@treeLikelihood.$(partition)"/>
			</operator>


	    	<!-- Adaptable -->
	    	<operator id="AdaptableOperatorSampler.geneHeights.inner" spec="orc.operators.AdaptableOperatorSampler" weight="1.0">

		    	
	       		<tree idref="GeneTree.t:$(partition)"/>


		         <!-- Root scale -->
		        <operator id="TreeRootScaler.t:geneTrees" spec="starbeast3.operators.TreeScaleOperator" rootOnly="true" scaleFactor="0.7" weight="1.0">
		        	<gene idref="treePrior.t:$(partition)"/>
		        </operator>

		         <!-- Tree scale -->
		        <operator id="TreeScaler.t:geneTrees" spec="starbeast3.operators.TreeScaleOperator" scaleFactor="0.95" weight="1.0">
		        	<gene idref="treePrior.t:$(partition)"/>   
		        </operator>
		        


				<!-- Uniform -->
		    	<operator id="UniformOperator.t:geneTrees" spec="starbeast3.operators.Uniform" weight="1.0">
					<gene idref="treePrior.t:$(partition)"/> 
		    	</operator>

		    	<!-- Subtree slide -->
		    	<operator id="SubtreeSlide.t:geneTrees" spec="starbeast3.operators.SubtreeSlide" size="0.002" weight="1.0">
	   				<gene idref="treePrior.t:$(partition)"/>
		    	</operator>
				

	

		  		 <!-- Node reheight  -->
		        <operator id="Reheight.t:Species" spec="starbeast3.operators.NodeReheight2" taxonset="@tree.taxonset" tree="@tree" weight="1.0">
					<gene idref="treePrior.t:$(partition)"/>
		        </operator>
		            
		        <!-- Coordinated uniform -->
		        <operator id="coordinatedUniform.t:Species" spec="starbeast3.operators.CoordinatedUniform" speciesTree="@tree" weight="1.0">
					<gene idref="treePrior.t:$(partition)"/>
		        </operator>
		            

		        <!-- Coordinated exponential -->
		        <operator id="coordinatedExponential.t:Species" spec="starbeast3.operators.CoordinatedExponential" speciesTree="@tree" weight="1.0">
					<gene idref="treePrior.t:$(partition)"/>
				</operator>

				
				<!-- UpDown  -->
				<operator id="updownAll:Species" spec="UpDownOperator" scaleFactor="0.75" weight="1.0">
		            <up idref="birthRate"/>
		            <down idref="tree"/>
		            <down idref="GeneTree.t:$(partition)"/>
		            <up idref="clockRate.c:$(partition)"/>
		            <down idref="popSize"/>
		            <down idref="popMean"/>
		        </operator>



		    </operator>


		</operator>

	</append>





	<!-- Population sizes -->
	<append id="gene.tree.prior.model.operator">

		<operator id="AdaptableOperatorSampler.popSize" spec="orc.operators.AdaptableOperatorSampler" weight="1.0" parameter="@popSize" dimensional="true">

			<!-- Gibbs operator -->
			<operator id="PopSizeGibbsSampler" spec='starbeast3.operators.PopSizeGibbsSampler' weight="1.0" popSizes="@popSize">
				<gammaprior id="gammaPrior" spec="beast.math.distributions.Gamma" alpha="2.0" beta="@popMean"/>
				<gene idref="treePrior.t:$(partition)"/>
			</operator>

		</operator>
		
		
	</append>


	<!-- Population size mean -->
	<append id="gene.tree.hyperprior.model.operator">

		<operator id="AdaptableOperatorSampler.popmean" spec="orc.operators.AdaptableOperatorSampler" weight="1.0" parameter="@popMean" dimensional="true">


			<!-- Scale -->
			<operator id="Scale.popmean" spec="BactrianScaleOperator" parameter="@popMean" scaleFactor="0.75" weight="1.0"/>


			<!-- UpDown -->
	        <operator idref="updownAll:Species" />

	        <!-- SampleFromPrior -->
			<operator id="SampleFromPriorOperator.popmean" spec="orc.operators.SampleFromPriorOperator" parameter="@popMean" np="1" prior="@popMeanLogNormal" weight="1"/>


		</operator>


	</append>


	<append id="SpeciesTreePriorPOEM">

	</append>



	<append id="GeneTreeTopologyPOEM">
		<log idref="TreeDistanceInit.t:$(partition)" />
		<log idref="TreeDistanceNJ.t:$(partition)" />
		<log idref="TreeDistanceUPGMA.t:$(partition)" />
		<log idref="speciescoalescent" />
	</append>


	<append id="GeneTreeNodeHeightPOEM">

		<log idref="speciescoalescent" />
	</append>



	<append id="GeneTreePriorPOEM">
		<log idref="popSize"/>
		<log idref="speciescoalescent" />
		<log idref="speciesTreePopPrior" />
		<log idref="SpeciesTreePopSize.Species" />
	</append>

	<append id="GeneTreeHyperPriorPOEM">
		<log idref="popMean"/>
	</append>



	<append id="TopologyPOEM">
		<log idref="TreeDistanceLogger.species" />
	</append>






	<!--
	<append id="TopologyPOEM.$(partition)">
		<log idref="TreeDistanceInit.t:$(partition)" />
		<log idref="TreeDistanceNJ.t:$(partition)" />
		<log idref="TreeDistanceUPGMA.t:$(partition)" />
		<log idref="speciescoalescent" />
		<operator idref="" />
	</append>
	-->


	<append id="screenlog">
		<log id="d.species" spec="beast.evolution.tree.TreeDistanceLogger" tree="@tree" />
		<log id="d.t:$(partition)" spec="beast.evolution.tree.TreeDistanceLogger" tree="@GeneTree.t:$(partition)" />
	</append>




	<append id="tracelog">
		<log id="TreeStat.t:GeneTree.$(partition)" spec="beast.evolution.tree.TreeStatLogger" tree="@GeneTree.t:$(partition)"/>
		
		<log id="TreeDistanceLogger.species" spec="beast.evolution.tree.TreeDistanceLogger" tree="@tree" />
		<log id="TreeDistanceInit.t:$(partition)" spec="beast.evolution.tree.TreeDistanceLogger" tree="@GeneTree.t:$(partition)" />
		<log id="TreeDistanceNJ.t:$(partition)" spec="beast.evolution.tree.TreeDistanceLogger" tree="@GeneTree.t:$(partition)" >
			<ref spec="beast.util.ClusterTree" clusterType="neighborjoining" taxa="@alignment.$(partition)"/>
		</log>
		<log id="TreeDistanceUPGMA.t:$(partition)" spec="beast.evolution.tree.TreeDistanceLogger" tree="@GeneTree.t:$(partition)" >
			<ref spec="beast.util.ClusterTree" clusterType="upgma" taxa="@alignment.$(partition)"/>
		</log>

		<log idref="popMean"/>
		<log idref="popSize"/>
		

	</append>





</fragment>
	


